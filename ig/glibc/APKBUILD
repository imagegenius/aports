# Maintainer: SpectX DevOps <devops@spectx.com>

pkgname="glibc"
pkgver="2.35"
_pkgrel="0"
pkgrel="1"
pkgdesc="GNU C Library compatibility layer"
arch="x86_64 aarch64"
url="https://github.com/sgerrand/alpine-pkg-glibc"
license="LGPL"
source="https://packages.imagegenius.io/glibc-bin-$pkgver-$_pkgrel-$CARCH.tar.gz
nsswitch.conf
ld.so.conf"
subpackages="$pkgname-bin $pkgname-dev $pkgname-i18n"
triggers="$pkgname-bin.trigger=/lib:/usr/lib:/usr/glibc-compat/lib"

package() {
	mkdir -p "$pkgdir/lib" "$pkgdir/usr/glibc-compat/lib/locale" "$pkgdir"/usr/glibc-compat/lib64 "$pkgdir"/etc
	cp -a "$srcdir"/usr "$pkgdir"
	cp "$srcdir"/ld.so.conf "$pkgdir"/usr/glibc-compat/etc/ld.so.conf
	cp "$srcdir"/nsswitch.conf "$pkgdir"/etc/nsswitch.conf
	rm "$pkgdir"/usr/glibc-compat/etc/rpc
	rm -rf "$pkgdir"/usr/glibc-compat/bin
	rm -rf "$pkgdir"/usr/glibc-compat/sbin
	rm -rf "$pkgdir"/usr/glibc-compat/lib/gconv
	rm -rf "$pkgdir"/usr/glibc-compat/lib/getconf
	rm -rf "$pkgdir"/usr/glibc-compat/lib/audit
	rm -rf "$pkgdir"/usr/glibc-compat/share
	rm -rf "$pkgdir"/usr/glibc-compat/var
	ln -s /usr/glibc-compat/lib/ld-linux-$CARCH.so.1 ${pkgdir}/lib/ld-linux-$CARCH.so.1
	ln -s /usr/glibc-compat/lib/ld-linux-$CARCH.so.1 ${pkgdir}/usr/glibc-compat/lib64/ld-linux-$CARCH.so.1
	ln -s /usr/glibc-compat/etc/ld.so.cache ${pkgdir}/etc/ld.so.cache
}

bin() {
	depends="$pkgname bash libc6-compat libgcc"
	mkdir -p "$subpkgdir"/usr/glibc-compat
	cp -a "$srcdir"/usr/glibc-compat/bin "$subpkgdir"/usr/glibc-compat
	cp -a "$srcdir"/usr/glibc-compat/sbin "$subpkgdir"/usr/glibc-compat
}

i18n() {
	depends="$pkgname-bin"
	arch="noarch"
	mkdir -p "$subpkgdir"/usr/glibc-compat
	cp -a "$srcdir"/usr/glibc-compat/share "$subpkgdir"/usr/glibc-compat
}

if [ "$CARCH" = "x86_64" ]; then
	sha512sums="
b0d08a2b3b7dc482daa135cd50315b20ec607ca61a01284828a9ec6f4d78bfa6af2a3e253fb860ec3c710146f601b68e245006c09bf99b77e0645307a1d4a9c8  glibc-bin-2.35-0-x86_64.tar.gz
478bdd9f7da9e6453cca91ce0bd20eec031e7424e967696eb3947e3f21aa86067aaf614784b89a117279d8a939174498210eaaa2f277d3942d1ca7b4809d4b7e  nsswitch.conf
2912f254f8eceed1f384a1035ad0f42f5506c609ec08c361e2c0093506724a6114732db1c67171c8561f25893c0dd5c0c1d62e8a726712216d9b45973585c9f7  ld.so.conf
"
elif [ "$CARCH" = "aarch64" ]; then
	sha512sums="
1d78881df81f587b0f29265eff68f914cd4772b498b5b9d513d442163a249f40a72307e4306731107e522f8853f3e6fd81fe15bf06cf6ef4c8a47139b3989e17  glibc-bin-2.35-0-aarch64.tar.gz
478bdd9f7da9e6453cca91ce0bd20eec031e7424e967696eb3947e3f21aa86067aaf614784b89a117279d8a939174498210eaaa2f277d3942d1ca7b4809d4b7e  nsswitch.conf
2912f254f8eceed1f384a1035ad0f42f5506c609ec08c361e2c0093506724a6114732db1c67171c8561f25893c0dd5c0c1d62e8a726712216d9b45973585c9f7  ld.so.conf
"
fi
